
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 로드 밸런싱 전략별 upstream 설정

    # 1. Round Robin (기본값)
    upstream backend_round_robin {
        server backend-1:8080;
        server backend-2:8080;
        server backend-3:8080;
    }

    # 2. Least Connections
    upstream backend_least_conn {
        least_conn;
        server backend-1:8080;
        server backend-2:8080;
        server backend-3:8080;
    }

    # 3. IP Hash (동일 IP는 동일 서버)
    upstream backend_ip_hash {
        ip_hash;
        server backend-1:8080;
        server backend-2:8080;
        server backend-3:8080;
    }

    # 4. Weight 기반
    upstream backend_weighted {
        server backend-1:8080 weight=3;
        server backend-2:8080 weight=2;
        server backend-3:8080 weight=1;
    }

    server {
        listen 80;
        server_name localhost;

        # SSE 엔드포인트 - Least Connection 전략
        location ^~ /api/sse {
            proxy_pass http://backend_least_conn;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # SSE 특화 설정
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400;

            # 업스트림 서버 정보 추가
            add_header X-Upstream-Server $upstream_addr always;
        }

        # WebSocket 엔드포인트 - IP Hash 전략 (세션 유지)
        location ^~ /ws/ {
            proxy_pass http://backend_ip_hash;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket 특화 설정
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;

            # 업스트림 서버 정보 추가
            add_header X-Upstream-Server $upstream_addr always;
        }

        # 일반 API 엔드포인트 - Weight 기반 전략
        location ^~ /api/ {
            proxy_pass http://backend_weighted;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 업스트림 서버 정보 추가
            add_header X-Upstream-Server $upstream_addr always;
        }

        # 정적 파일 서빙 - Round Robin
        location / {
            proxy_pass http://backend_round_robin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            add_header X-Upstream-Server $upstream_addr always;
        }
    }
}